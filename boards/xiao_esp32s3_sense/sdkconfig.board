#
# XIAO ESP32S3 Sense - Board Configuration
# All hardware-specific settings
#

CONFIG_IDF_TARGET="esp32s3"

# Flash - 8MB on XIAO
CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
CONFIG_ESPTOOLPY_FLASHFREQ_80M=y
CONFIG_ESPTOOLPY_FLASHMODE_QIO=y

# PSRAM - 8MB QSPI
CONFIG_ESP_PSRAM=y
CONFIG_ESP_PSRAM_MODE_QUAD=y
CONFIG_ESP_PSRAM_SIZE=8388608
CONFIG_ESP_PSRAM_SPEED_80M=y
CONFIG_ESP_PSRAM_MALLOC=y
CONFIG_ESP_PSRAM_MALLOC_ALWAYSINTERNAL=16384
CONFIG_ESP_PSRAM_ALLOW_BSS_SEG_EXTERNAL_MEMORY=y

# Console - USB Serial/JTAG
CONFIG_ESP_CONSOLE_USB_SERIAL_JTAG=y
CONFIG_ESP_CONSOLE_SECONDARY_USB_SERIAL_JTAG=y
CONFIG_USB_CDC_ENABLED=y

# CPU - 240MHz max
CONFIG_ESP_DEFAULT_CPU_FREQ_MHZ_240=y
CONFIG_ESP_DEFAULT_CPU_FREQ_MHZ=240

# XIAO GPIO Overrides
CONFIG_BLINK_GPIO=21
CONFIG_BLINK_LED_GPIO=y
CONFIG_LED_STRIP_GPIO=21

# WiFi optimization
CONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=10
CONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=32
CONFIG_ESP_WIFI_TASK_CORE_ID=0

# Power Management
CONFIG_PM_ENABLE=y

# Logging
CONFIG_LOG_DEFAULT_LEVEL_INFO=y
CONFIG_LOG_COLORS=y


# ============================================================================
# Camera Configuration - OV3660
# ============================================================================
CONFIG_CAMERA_CORE0=y
CONFIG_CAMERA_DMA_BUFFER_SIZE_MAX=32768

# OV3660 requires more memory
#CONFIG_ESP_PSRAM_MALLOC_ALWAYSINTERNAL=8192
#CONFIG_ESP_PSRAM_MALLOC_ALWAYSINTERNAL=4096

# WiFi for streaming
CONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=16
CONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=64

# HTTP Server
CONFIG_HTTPD_MAX_REQ_HDR_LEN=1024
CONFIG_HTTPD_MAX_URI_LEN=512
CONFIG_HTTPD_ERR_RESP_NO_DELAY=y

# ============================================================================
# Camera PSRAM Configuration (ADD THIS SECTION)
# ============================================================================

# Reduce internal-only memory to free more PSRAM
CONFIG_ESP_PSRAM_MALLOC_ALWAYSINTERNAL=4096

# Enable PSRAM for camera
CONFIG_CAMERA_FB_IN_PSRAM=y

# Increase PSRAM heap
CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL=0

# PSRAM cache workaround for camera
CONFIG_SPIRAM_FETCH_INSTRUCTIONS=y
CONFIG_SPIRAM_RODATA=y

# ============================================================================
# PSRAM - XIAO ESP32S3 Sense has OCTAL PSRAM!
# ============================================================================
CONFIG_ESP_PSRAM=y

# CRITICAL: Use OCTAL mode, not QUAD!
CONFIG_SPIRAM_MODE_OCT=y
CONFIG_SPIRAM_TYPE_ESPPSRAM64=y
CONFIG_SPIRAM_SPEED_40M=y

CONFIG_SPIRAM=y
CONFIG_SPIRAM_BOOT_INIT=y
CONFIG_SPIRAM_USE_MALLOC=y
CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL=4096

# Camera needs PSRAM
CONFIG_CAMERA_FB_IN_PSRAM=y
CONFIG_CAMERA_PSRAM_DMA_MODE=y